<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- SEO Meta Tags -->
  <title>Qui√©n Se Va</title>
  <meta name="description" content="Simulador interactivo de descenso del f√∫tbol argentino. Calcula qu√© equipos descienden seg√∫n tabla anual y promedios. Simula resultados en tiempo real.">
  <meta name="keywords" content="descenso, f√∫tbol argentino, tabla de promedios, simulador, tabla anual, descenso 2025">
  <meta name="author" content="QuienSeVa">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="https://quienseva.netlify.app">

  <!-- Open Graph / Facebook / WhatsApp -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://quienseva.netlify.app">
  <meta property="og:title" content="¬øQui√©n Se Va? - Simulador de Descenso F√∫tbol Argentino">
  <meta property="og:description" content="Simulador interactivo de descenso del f√∫tbol argentino. Calcula qu√© equipos descienden seg√∫n tabla anual y promedios.">
  <meta property="og:image" content="https://quienseva.netlify.app/img/og-image.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:image:alt" content="Qui√©n Se Va - Simulador de Descenso">
  <meta property="og:locale" content="es_AR">
  <meta property="og:site_name" content="Qui√©n Se Va">

  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://quienseva.netlify.app">
  <meta property="twitter:title" content="¬øQui√©n Se Va? - Simulador de Descenso F√∫tbol Argentino">
  <meta property="twitter:description" content="Simulador interactivo de descenso del f√∫tbol argentino. Calcula qu√© equipos descienden seg√∫n tabla anual y promedios.">
  <meta property="twitter:image" content="https://quienseva.netlify.app/img/og-image.png">
  <meta property="twitter:image:alt" content="Qui√©n Se Va - Simulador de Descenso">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="img/favicon.png">
  <link rel="apple-touch-icon" href="img/favicon.png">
  <link rel="shortcut icon" type="image/png" href="img/favicon.png">

  <!-- Theme Color -->
  <meta name="theme-color" content="#0f172a">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    /* Estilos base fijos para captura */
    * {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    body {
      font-size: 16px;
    }
    
    .tabla-nombre {
      font-size: 0.875rem;
    }
    
    .tabla-puntos {
      font-size: 1.5rem;
    }
    
    .tabla-promedio {
      font-size: 1.5rem;
    }
    
    .tabla-info {
      font-size: 0.75rem;
    }
    
    .tabla-posicion {
      font-size: 1rem;
    }
    
    .titulo-tabla {
      font-size: 1.25rem;
    }
    
    .btn-reset {
      font-size: 0.875rem;
      padding: 0.5rem 1rem;
      white-space: nowrap;
    }
    
    .regla-descenso {
      font-size: 0.875rem;
      padding: 0.75rem;
    }
    
    .partido-info {
      font-size: 0.75rem;
    }
    
    .equipo-titulo {
      font-size: 1rem;
    }
    
    @media (max-width: 768px) {
      body {
        font-size: 14px;
      }
      .tabla-nombre {
        font-size: 0.75rem !important;
      }
      .tabla-promedio {
        font-size: 1rem !important;
      }
      .tabla-info {
        font-size: 0.625rem !important;
      }
      .tabla-posicion {
        font-size: 0.875rem !important;
      }
      .titulo-tabla {
        font-size: 1rem !important;
      }
      .titulo-principal {
        font-size: 1.5rem !important;
      }
      .btn-reset {
        font-size: 0.75rem !important;
        padding: 0.375rem 0.75rem !important;
      }
      .regla-descenso {
        font-size: 0.7rem !important;
        padding: 0.5rem !important;
      }
      .partido-info {
        font-size: 0.625rem !important;
      }
      .equipo-titulo {
        font-size: 0.875rem !important;
      }
      /* Reducir padding general en m√≥viles */
      #root > div {
        padding: 0.5rem !important;
      }
    }

    @media (max-width: 417px) {
      .hide-pos-mobile .tabla-posicion {
        display: none !important;
      }
    }

    @media (max-width: 369px) {
      .hide-pos-mobile img[alt] {
        display: none !important;
      }
    }
    .donation-content {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .qr-container {
      background: white;
      padding: 0.5rem;
      border-radius: 0.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .qr-container img {
      display: block;
      max-width: 100px;
      width: 100%;
      height: auto;
      border-radius: 0.25rem;
    }

    .donation-info {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      align-items: flex-start;
    }

    .donation-title {
      color: #000;
      font-size: 0.875rem;
      font-weight: 600;
      margin: 0;
    }

    .alias-container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 0.375rem;
      display: inline-block;
    }

    .alias-label {
      color: #4a5568;
      font-size: 0.625rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .alias-value {
      color: #1a202c;
      font-size: 1rem;
      font-weight: bold;
      font-family: monospace;
      letter-spacing: 0.05em;
    }

    @media (max-width: 768px) {
      .donation-section {
        padding: 0.5rem 0.75rem;
      }

      .donation-content {
        gap: 0.75rem;
      }

      .qr-container img {
        width: 100px;
      }

      .donation-title {
        font-size: 0.75rem;
      }

      .alias-value {
        font-size: 0.875rem;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="module">
    import React, { useState, useMemo } from 'https://esm.sh/react@18';
    import ReactDOM from 'https://esm.sh/react-dom@18/client';
    import { Trophy, TrendingDown } from 'https://esm.sh/lucide-react@0.263.1';

    // √çcono de X (Twitter)
    const XIcon = ({ size = 16, className = '' }) =>
      React.createElement('svg', {
        width: size,
        height: size,
        viewBox: '0 0 24 24',
        fill: 'currentColor',
        className
      },
        React.createElement('path', {
          d: 'M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z'
        })
      );

    const { createElement: h } = React;

    function App() {
      const [modoCalculo, setModoCalculo] = React.useState('seguro'); // 'seguro' o 'aproximado'
      const [mostrarPromedios, setMostrarPromedios] = React.useState(false);
      const [esMobile, setEsMobile] = React.useState(window.innerWidth <= 768);

      React.useEffect(() => {
        const handleResize = () => {
          setEsMobile(window.innerWidth <= 768);
        };
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
      }, []);

      const equiposIniciales = [
        {
          id: 'GIM',
          nombre: 'Gimnasia',
          escudo: 'img/clubes/gimnasia.png',
          pj: 28,
          puntos: 29,
          pjPromedios: 110,
          puntosPromedios: 122,
          partidos: [
            { rival: 'Talleres', rivalId: 'TAL', condicion: 'L', fecha: 28, partidoId: 'GIM-TAL-28', jugado: true },
            { rival: 'Estudiantes', rivalId: null, condicion: 'V', fecha: 29, partidoId: 'GIM-EST-29' },
            { rival: 'River', rivalId: null, condicion: 'V', fecha: 30, partidoId: 'GIM-RIV-30' },
            { rival: 'V√©lez', rivalId: null, condicion: 'L', fecha: 31, partidoId: 'GIM-VEL-31' },
            { rival: 'Platense', rivalId: null, condicion: 'V', fecha: 32, partidoId: 'GIM-PLA-32' }
          ]
        },
        {
          id: 'BAN',
          nombre: 'Banfield',
          escudo: 'img/clubes/banfield.png',
          pj: 29,
          puntos: 31,
          pjPromedios: 111,
          puntosPromedios: 124,
          partidos: [
            { rival: 'Racing', rivalId: null, condicion: 'L', fecha: 28, partidoId: 'BAN-RAC-28', jugado: true },
            { rival: 'Indep. Rivadavia', rivalId: null, condicion: 'V', fecha: 29, partidoId: 'BAN-IRV-29', jugado: true },
            { rival: 'Lan√∫s', rivalId: null, condicion: 'L', fecha: 30, partidoId: 'BAN-LAN-30' },
            { rival: 'Aldosivi', rivalId: 'ALD', condicion: 'L', fecha: 31, partidoId: 'BAN-ALD-31' },
            { rival: 'Central C√≥rdoba', rivalId: null, condicion: 'V', fecha: 32, partidoId: 'BAN-CCO-32' }
          ]
        },
        {
          id: 'SAR',
          nombre: 'Sarmiento',
          escudo: 'img/clubes/sarmiento.png',
          pj: 27,
          puntos: 30,
          pjPromedios: 109,
          puntosPromedios: 111,
          partidos: [
            { rival: 'Rosario Central', rivalId: null, condicion: 'V', fecha: 23, pendiente: true, partidoId: 'SAR-RCE-27' },
            { rival: 'River', rivalId: null, condicion: 'V', fecha: 28, partidoId: 'SAR-RIV-28', jugado: true },
            { rival: 'V√©lez', rivalId: null, condicion: 'L', fecha: 29, partidoId: 'SAR-VEL-29' },
            { rival: 'Platense', rivalId: null, condicion: 'V', fecha: 30, partidoId: 'SAR-PLA-30' },
            { rival: 'Instituto', rivalId: null, condicion: 'L', fecha: 31, partidoId: 'SAR-INS-31' },
            { rival: 'San Lorenzo', rivalId: null, condicion: 'V', fecha: 32, partidoId: 'SAR-SLO-32' }
          ]
        },
        {
          id: 'TAL',
          nombre: 'Talleres',
          escudo: 'img/clubes/talleres.png',
          pj: 28,
          puntos: 27,
          pjPromedios: 110,
          puntosPromedios: 166,
          partidos: [
            { rival: 'Gimnasia', rivalId: 'GIM', condicion: 'V', fecha: 28, partidoId: 'GIM-TAL-28', jugado: true },
            { rival: 'River', rivalId: null, condicion: 'L', fecha: 29, partidoId: 'TAL-RIV-29' },
            { rival: 'V√©lez', rivalId: null, condicion: 'V', fecha: 30, partidoId: 'TAL-VEL-30' },
            { rival: 'Platense', rivalId: null, condicion: 'L', fecha: 31, partidoId: 'TAL-PLA-31' },
            { rival: 'Instituto', rivalId: null, condicion: 'V', fecha: 32, partidoId: 'TAL-INS-32' }
          ]
        },
        {
          id: 'GOD',
          nombre: 'Godoy Cruz',
          escudo: 'img/clubes/godoycruz.png',
          pj: 29,
          puntos: 27,
          pjPromedios: 111,
          puntosPromedios: 154,
          partidos: [
            { rival: 'Indep. Rivadavia', rivalId: null, condicion: 'V', fecha: 28, partidoId: 'GOD-IRV-28', jugado: true },
            { rival: 'Lan√∫s', rivalId: null, condicion: 'V', fecha: 29, partidoId: 'GOD-LAN-29', jugado: true },
            { rival: 'San Mart√≠n', rivalId: 'SMA', condicion: 'L', fecha: 30, partidoId: 'GOD-SMA-30' },
            { rival: 'Atl. Tucum√°n', rivalId: null, condicion: 'V', fecha: 31, partidoId: 'GOD-ATU-31' },
            { rival: 'Riestra', rivalId: null, condicion: 'L', fecha: 32, partidoId: 'GOD-RIE-32' }
          ]
        },
        {
          id: 'SMA',
          nombre: 'San Mart√≠n',
          escudo: 'img/clubes/sanmartin.png',
          pj: 28,
          puntos: 23,
          pjPromedios: 28,
          puntosPromedios: 23,
          partidos: [
            { rival: 'San Lorenzo', rivalId: null, condicion: 'V', fecha: 28, partidoId: 'SMA-SLO-28', jugado: true },
            { rival: 'Independiente', rivalId: null, condicion: 'L', fecha: 29, partidoId: 'SMA-IND-29' },
            { rival: 'Godoy Cruz', rivalId: 'GOD', condicion: 'V', fecha: 30, partidoId: 'GOD-SMA-30' },
            { rival: 'Lan√∫s', rivalId: null, condicion: 'L', fecha: 31, partidoId: 'SMA-LAN-31' },
            { rival: 'Aldosivi', rivalId: 'ALD', condicion: 'V', fecha: 32, partidoId: 'ALD-SMA-32' }
          ]
        },
        {
          id: 'ALD',
          nombre: 'Aldosivi',
          escudo: 'img/clubes/aldosivi.png',
          pj: 29,
          puntos: 24,
          pjPromedios: 29,
          puntosPromedios: 24,
          partidos: [
            { rival: 'Hurac√°n', rivalId: null, condicion: 'L', fecha: 28, partidoId: 'ALD-HUR-28', jugado: true },
            { rival: 'Racing', rivalId: null, condicion: 'V', fecha: 29, partidoId: 'ALD-RAC-29', jugado: true },
            { rival: 'Indep. Rivadavia', rivalId: null, condicion: 'L', fecha: 30, partidoId: 'ALD-IRV-30' },
            { rival: 'Banfield', rivalId: 'BAN', condicion: 'V', fecha: 31, partidoId: 'BAN-ALD-31' },
            { rival: 'San Mart√≠n', rivalId: 'SMA', condicion: 'L', fecha: 32, partidoId: 'ALD-SMA-32' }
          ]
        },
        {
          id: 'NEW',
          nombre: 'Newell\'s',
          escudo: 'img/clubes/newells.png',
          pj: 29,
          puntos: 30,
          pjPromedios: 111,
          puntosPromedios: 132,
          partidos: [
            { rival: 'Tigre', rivalId: null, condicion: 'V', fecha: 28, partidoId: 'NEW-TIG-28', jugado: true },
            { rival: 'Argentinos Jrs', rivalId: null, condicion: 'V', fecha: 29, partidoId: 'NEW-ARG-29', jugado: true },
            { rival: 'Uni√≥n', rivalId: null, condicion: 'L', fecha: 30, partidoId: 'NEW-UNI-30' },
            { rival: 'Hurac√°n', rivalId: null, condicion: 'V', fecha: 31, partidoId: 'NEW-HUR-31' },
            { rival: 'Racing', rivalId: null, condicion: 'L', fecha: 32, partidoId: 'NEW-RAC-32' }
          ]
        }
      ];

      const [resultados, setResultados] = useState({
        'GIM-TAL-28': 'TAL', // Talleres gan√≥ a Gimnasia
        'BAN-RAC-28': 'EXT', // Racing gan√≥ a Banfield
        'SMA-SLO-28': 'SMA', // San Mart√≠n gan√≥ a San Lorenzo
        'ALD-HUR-28': 'ALD', // Aldosivi gan√≥ a Hurac√°n
        'GOD-IRV-28': 'E',   // Godoy Cruz empat√≥ con Indep. Rivadavia
        'SAR-RIV-28': 'SAR', // Sarmiento gan√≥ a River
        'NEW-TIG-28': 'E',   // Newell's empat√≥ con Tigre
        'ALD-RAC-29': 'EXT', // Aldosivi perdi√≥ contra Racing
        'NEW-ARG-29': 'EXT', // Newell's perdi√≥ contra Argentinos Jrs
        'GOD-LAN-29': 'EXT', // Godoy Cruz perdi√≥ contra Lan√∫s
        'BAN-IRV-29': 'BAN'  // Banfield gan√≥ a Independiente Rivadavia
      });

      const calcularTabla = useMemo(() => {
        const equiposCalculados = equiposIniciales.map(equipo => {
          let puntosTemporada = equipo.puntos;
          let pjTemporada = equipo.pj;
          let puntosPromediosTotales = equipo.puntosPromedios;
          let pjPromediosTotales = equipo.pjPromedios;
          let partidosRestantes = 0;

          equipo.partidos.forEach((partido) => {
            const resultado = resultados[partido.partidoId];
            const esPartidoJugado = partido.jugado === true;

            if (resultado && !esPartidoJugado) {
              pjTemporada += 1;
              pjPromediosTotales += 1;

              if (resultado === equipo.id) {
                puntosTemporada += 3;
                puntosPromediosTotales += 3;
              } else if (resultado === 'E') {
                puntosTemporada += 1;
                puntosPromediosTotales += 1;
              }
            } else if (!resultado && !esPartidoJugado) {
              partidosRestantes += 1;
            }
          });

          const promedio = puntosPromediosTotales / pjPromediosTotales;

          return {
            ...equipo,
            puntosTemporada,
            pjTemporada,
            puntosPromediosTotales,
            pjPromediosTotales,
            promedio,
            partidosRestantes
          };
        });

        const porTabla = [...equiposCalculados].sort((a, b) => b.puntosTemporada - a.puntosTemporada);
        const porPromedios = [...equiposCalculados].sort((a, b) => b.promedio - a.promedio);

        // 1. PRIMER DESCENDIDO: √öltimo promedio
        const ultimoPromedio = porPromedios[porPromedios.length - 1];
        const promedioUltimo = parseFloat(ultimoPromedio.promedio.toFixed(3));
        
        // Buscar todos los equipos con el mismo promedio m√°s bajo
        const equiposConPromedioMasBajo = porPromedios.filter(e => 
          parseFloat(e.promedio.toFixed(3)) === promedioUltimo
        );

        let descendidoPorPromedios = null;
        let hayEmpatePromedios = false;
        let equiposEmpatadosPromedios = [];

        if (equiposConPromedioMasBajo.length > 1) {
          // Hay empate en promedios - se define por partido definitorio
          // NO asignamos descendido hasta que se juegue el definitorio
          hayEmpatePromedios = true;
          equiposEmpatadosPromedios = equiposConPromedioMasBajo.map(e => e.id);
          descendidoPorPromedios = null; // Sin descendido hasta definir
        } else {
          descendidoPorPromedios = ultimoPromedio;
        }

        // 2. SEGUNDO DESCENDIDO: √öltimo en tabla anual (excluyendo al primero)
        const ultimoPorTabla = porTabla[porTabla.length - 1];
        let descendidoPorTabla = null;
        let hayDefinitorioPorTabla = false;
        let equiposDefinitorioPorTabla = [];

        // Si hay empate en promedios, no sabemos qui√©n desciende por promedios a√∫n
        if (hayEmpatePromedios) {
          // Buscamos el √∫ltimo por tabla sin excluir a nadie todav√≠a
          const puntajeUltimo = ultimoPorTabla.puntosTemporada;
          const equiposConMismoPuntaje = porTabla.filter(e => 
            e.puntosTemporada === puntajeUltimo
          );

          if (equiposConMismoPuntaje.length > 1) {
            hayDefinitorioPorTabla = true;
            equiposDefinitorioPorTabla = equiposConMismoPuntaje.map(e => e.id);
            descendidoPorTabla = null; // Sin descendido hasta definir
          } else {
            descendidoPorTabla = ultimoPorTabla;
          }
        }
        // Si el √∫ltimo por promedios tambi√©n es √∫ltimo por tabla
        else if (descendidoPorPromedios && descendidoPorPromedios.id === ultimoPorTabla.id) {
          // Excluimos al primero y tomamos el pen√∫ltimo en tabla
          const tablaSinPrimero = porTabla.filter(e => e.id !== descendidoPorPromedios.id);
          const penultimoPorTabla = tablaSinPrimero[tablaSinPrimero.length - 1];
          const puntajePenultimo = penultimoPorTabla.puntosTemporada;

          // Buscar todos los equipos con el mismo puntaje m√°s bajo (excluyendo al primero)
          const equiposConMismoPuntaje = tablaSinPrimero.filter(e => 
            e.puntosTemporada === puntajePenultimo
          );

          if (equiposConMismoPuntaje.length > 1) {
            hayDefinitorioPorTabla = true;
            equiposDefinitorioPorTabla = equiposConMismoPuntaje.map(e => e.id);
            descendidoPorTabla = null; // Sin descendido hasta definir
          } else {
            descendidoPorTabla = penultimoPorTabla;
          }
        } else {
          // El √∫ltimo por promedios NO es el √∫ltimo por tabla
          const puntajeUltimo = ultimoPorTabla.puntosTemporada;
          
          // Buscar todos los equipos con el mismo puntaje m√°s bajo
          const equiposConMismoPuntaje = porTabla.filter(e => 
            e.puntosTemporada === puntajeUltimo && (!descendidoPorPromedios || e.id !== descendidoPorPromedios.id)
          );

          if (equiposConMismoPuntaje.length > 1) {
            hayDefinitorioPorTabla = true;
            equiposDefinitorioPorTabla = equiposConMismoPuntaje.map(e => e.id);
            descendidoPorTabla = null; // Sin descendido hasta definir
          } else if (equiposConMismoPuntaje.length === 1) {
            descendidoPorTabla = equiposConMismoPuntaje[0];
          } else if (descendidoPorPromedios) {
            // Si el √∫ltimo es el que desciende por promedios, tomamos el pen√∫ltimo
            const tablaSinPrimero = porTabla.filter(e => e.id !== descendidoPorPromedios.id);
            descendidoPorTabla = tablaSinPrimero[tablaSinPrimero.length - 1];
          }
        }

        let equiposEmpatados = hayDefinitorioPorTabla ? equiposDefinitorioPorTabla : [];
        let hayEmpate = hayDefinitorioPorTabla;

        const equiposConPuntosNecesarios = porTabla.map(equipoActual => {
          const cantidadDescienden = 2;
          let puntosNecesarios = 0;

          if (modoCalculo === 'seguro') {
            // Valores hardcodeados basados en c√°lculo oficial del modo seguro
            const puntosNecesariosPorEquipo = {
              'SMA': 12,  // San Mart√≠n
              'GOD': 7,   // Godoy Cruz
              'TAL': 7,   // Talleres
              'BAN': 6,   // Banfield
              'GIM': 5,   // Gimnasia
              'NEW': 4,   // Newell's
              'SAR': 4,   // Sarmiento
              'ALD': equipoActual.partidosRestantes * 3  // Aldosivi: necesita ganar todo pero depende de otros
            };

            puntosNecesarios = puntosNecesariosPorEquipo[equipoActual.id] || 0;
          } else {
            const objetivoSalvacion = 31;
            puntosNecesarios = Math.max(0, objetivoSalvacion - equipoActual.puntosTemporada);
          }

          return {
            ...equipoActual,
            puntosNecesarios
          };
        });

        return {
          equipos: equiposConPuntosNecesarios,
          descendidoPorPromedios: descendidoPorPromedios?.id,
          descendidoPorTabla: descendidoPorTabla?.id,
          tablaPromedios: porPromedios,
          hayEmpateTabla: hayEmpate,
          equiposEmpatadosTabla: equiposEmpatados,
          hayEmpatePromedios: hayEmpatePromedios,
          equiposEmpatadosPromedios: equiposEmpatadosPromedios
        };
      }, [resultados, modoCalculo]);

      const handleResultado = (partidoId, ganadorId, esLocal, esEmpate = false) => {
        setResultados(prev => {
          const resultadoActual = prev[partidoId];

          if (esEmpate) {
            return {
              ...prev,
              [partidoId]: resultadoActual === 'E' ? null : 'E'
            };
          }

          return {
            ...prev,
            [partidoId]: resultadoActual === ganadorId ? null : ganadorId
          };
        });
      };

      const resetearTodo = () => {
        setResultados({
          'GIM-TAL-28': 'TAL', // Mantener el partido Talleres vs Gimnasia
          'BAN-RAC-28': 'EXT', // Mantener el partido Racing vs Banfield
          'SMA-SLO-28': 'SMA', // Mantener el partido San Mart√≠n vs San Lorenzo
          'ALD-HUR-28': 'ALD', // Mantener el partido Aldosivi vs Hurac√°n
          'GOD-IRV-28': 'E',   // Mantener el partido Godoy Cruz vs Indep. Rivadavia
          'SAR-RIV-28': 'SAR', // Mantener el partido Sarmiento vs River
          'NEW-TIG-28': 'E',   // Mantener el partido Newell's vs Tigre
          'ALD-RAC-29': 'EXT', // Mantener el partido Aldosivi vs Racing
          'NEW-ARG-29': 'EXT', // Mantener el partido Newell's vs Argentinos Jrs
          'GOD-LAN-29': 'EXT', // Mantener el partido Godoy Cruz vs Lan√∫s
          'BAN-IRV-29': 'BAN'  // Mantener el partido Banfield vs Independiente Rivadavia
        });
      };

      const capturarImagen = async () => {
        try {
          // Scroll al top
          window.scrollTo(0, 0);
          await new Promise(resolve => setTimeout(resolve, 300));

          // Capturar solo el contenedor de tablas y simulaci√≥n
          const elemento = document.getElementById('captura-container');
          
          if (!elemento) {
            alert('No se pudo encontrar el contenedor');
            return;
          }
          
          // Guardar estilos originales
          const originalStyles = {
            bodyOverflow: document.body.style.overflow,
            htmlOverflow: document.documentElement.style.overflow,
            bodyHeight: document.body.style.height,
            elementPosition: elemento.style.position
          };
          
          // Aplicar estilos para captura
          document.body.style.overflow = 'visible';
          document.documentElement.style.overflow = 'visible';
          document.body.style.height = 'auto';
          elemento.style.position = 'static';
          
          // Forzar reflow
          void elemento.offsetHeight;
          
          await new Promise(resolve => setTimeout(resolve, 200));
          
          // Obtener las dimensiones reales del elemento
          const rect = elemento.getBoundingClientRect();
          const parentRect = elemento.parentElement.getBoundingClientRect();
          
          const canvas = await html2canvas(elemento, {
            backgroundColor: '#0f172a',
            scale: 2,
            logging: false,
            useCORS: true,
            allowTaint: true,
            foreignObjectRendering: false,
            imageTimeout: 0,
            removeContainer: true,
            width: rect.width,
            height: rect.height,
            x: rect.left - parentRect.left,
            y: 0,
            scrollY: 0,
            scrollX: 0,
            onclone: (clonedDoc) => {
              const clonedContainer = clonedDoc.getElementById('captura-container');
              if (clonedContainer) {
                // Aplicar estilos al contenedor clonado
                clonedContainer.style.position = 'static';
                clonedContainer.style.transform = 'none';
                clonedContainer.style.top = '0';
                clonedContainer.style.left = '0';
                clonedContainer.style.margin = '0 auto';
                
                // Recorrer todos los elementos y corregir estilos
                const allElements = clonedContainer.querySelectorAll('*');
                allElements.forEach(el => {
                  // Remover transforms
                  el.style.transform = 'none';
                  el.style.webkitTransform = 'none';
                  
                  // Mantener font-size computado
                  const computedStyle = window.getComputedStyle(el);
                  if (computedStyle.fontSize) {
                    el.style.fontSize = computedStyle.fontSize;
                  }
                  
                  // Asegurar overflow visible en textos
                  if (el.tagName === 'SPAN' || el.tagName === 'DIV' || el.tagName === 'P' || el.tagName === 'A') {
                    el.style.overflow = 'visible';
                    el.style.textOverflow = 'clip';
                    el.style.whiteSpace = computedStyle.whiteSpace;
                  }
                  
                  // Botones con texto completo
                  if (el.tagName === 'BUTTON') {
                    el.style.overflow = 'visible';
                    el.style.whiteSpace = 'nowrap';
                    el.style.fontSize = computedStyle.fontSize;
                    el.style.padding = computedStyle.padding;
                  }
                });
              }
            }
          });

          // Restaurar estilos originales
          document.body.style.overflow = originalStyles.bodyOverflow;
          document.documentElement.style.overflow = originalStyles.htmlOverflow;
          document.body.style.height = originalStyles.bodyHeight;
          elemento.style.position = originalStyles.elementPosition;

          // Descargar imagen
          canvas.toBlob((blob) => {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `quien-se-va-${new Date().getTime()}.png`;
            link.click();
            URL.revokeObjectURL(url);
          }, 'image/png', 1.0);
          
        } catch (error) {
          console.error('Error al capturar imagen:', error);
          alert('Error al capturar la imagen. Intenta nuevamente.');
        }
      };

      const esDescendido = (equipoId) => {
        // Si hay empate en promedios, no marcar como descendido hasta que se defina
        if (calcularTabla.hayEmpatePromedios && calcularTabla.equiposEmpatadosPromedios.includes(equipoId)) {
          return false;
        }
        // Si hay empate en tabla, no marcar como descendido hasta que se defina
        if (calcularTabla.hayEmpateTabla && calcularTabla.equiposEmpatadosTabla.includes(equipoId)) {
          return false;
        }
        return equipoId === calcularTabla.descendidoPorPromedios || 
               equipoId === calcularTabla.descendidoPorTabla;
      };

      const tipoDescenso = (equipoId) => {
        // No mostrar tipo de descenso si hay empate
        if (calcularTabla.hayEmpatePromedios && calcularTabla.equiposEmpatadosPromedios.includes(equipoId)) {
          return null;
        }
        if (calcularTabla.hayEmpateTabla && calcularTabla.equiposEmpatadosTabla.includes(equipoId)) {
          return null;
        }
        
        if (equipoId === calcularTabla.descendidoPorPromedios &&
            equipoId === calcularTabla.descendidoPorTabla) {
          return 'Ambos';
        }
        if (equipoId === calcularTabla.descendidoPorPromedios) return 'Promedios';
        if (equipoId === calcularTabla.descendidoPorTabla) return 'Tabla';
        return null;
      };

      const esEmpateDescenso = (equipoId) => {
        return calcularTabla.equiposEmpatadosTabla.includes(equipoId);
      };

      const esEmpatePromedios = (equipoId) => {
        return calcularTabla.equiposEmpatadosPromedios.includes(equipoId);
      };

      return h('div', { className: 'min-h-screen bg-slate-950 p-4' },
        h('div', { className: 'max-w-7xl mx-auto' },
          h('div', { className: 'bg-white rounded-lg shadow-2xl p-3 md:p-6 mb-4 md:mb-6' },
            h('div', { className: 'flex items-center justify-between mb-3 md:mb-4' },
              h('div', { className: 'flex items-center gap-2 md:gap-3' },
                h('img', {
                  src: 'img/favicon.png',
                  alt: '¬øQui√©n Se Va?',
                  className: 'h-40 md:h-16 w-auto'
                }),
                h('a', {
                  href: 'https://x.com/zorritofassi',
                  target: '_blank',
                  rel: 'noopener noreferrer',
                  className: 'flex items-center gap-1 text-xs md:text-sm text-slate-950 hover:text-blue-600 transition-colors font-semibold'
                },
                  // h(XIcon, { size: 14, className: 'md:w-4 md:h-4' }),
                  // 'ZorritoFassi'
                )
              ),
              h('div', { className: 'flex flex-col md:flex-row gap-2' },
                esMobile && h('button', {
                  onClick: () => setMostrarPromedios(!mostrarPromedios),
                  className: 'btn-reset px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold shadow-md text-xs'
                }, mostrarPromedios ? 'üëÅÔ∏è Ocultar Promedios' : 'üëÅÔ∏è Mostrar Promedios'),
                h('button', {
                  onClick: capturarImagen,
                  className: 'btn-reset px-4 md:px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold shadow-md text-xs md:text-sm'
                }, 'üì∏ Capturar'),
                h('button', {
                  onClick: resetearTodo,
                  className: 'btn-reset px-4 md:px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold shadow-md text-xs md:text-sm'
                }, 'Resetear'),
                h('button', {
                  onClick: () => setModoCalculo(modoCalculo === 'seguro' ? 'aproximado' : 'seguro'),
                  className: 'btn-reset px-3 md:px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold shadow-md text-xs md:text-sm w-36 md:w-44'
                }, modoCalculo === 'seguro' ? 'Modo: Seguro' : 'Modo: Aproximado')
              )
            ),
            h('div', { className: 'regla-descenso bg-blue-50 border-l-4 border-blue-500 p-2 md:p-3 text-sm mb-2 md:mb-3' },
              h('div', null,
                h('strong', null, 'Descienden 2 equipos: '),
                ' el √∫ltimo por promedios de las √∫ltimas 3 temporadas y el √∫ltimo por tabla anual (excluyendo al primero). Si coinciden, desciende tambi√©n el pen√∫ltimo de la tabla. Si hay empate en puntos en zona de descenso, se define por partido definitorio.'
              ),
              h('div', { className: 'mt-2 text-xs' },
                h('strong', null, modoCalculo === 'seguro' ? 'Modo Seguro: ' : 'Modo Aproximado: '),
                modoCalculo === 'seguro'
                  ? 'Puntos necesarios para salvarse sin depender de nadie (todos ganan todo).'
                  : 'Puntos aproximados basados en hist√≥rico de salvaci√≥n (~31 puntos).'
              )
            ),
            // h('div', { className: '' },
            //   h('div', { className: 'donation-content' },
            //     h('div', { className: 'qr-container' },
            //       h('img', {
            //         src: 'img/QR.jpg',
            //         alt: 'QR para donaciones',
            //         loading: 'lazy'
            //       })
            //     ),
            //     h('div', { className: 'donation-info' },
            //       h('h3', { className: 'text-lg md:text-xl font-bold text-gray-800 mb-1' }, 'Donaciones'),
            //       h('div', { className: 'donation-title' }, 'Todo aporte es bienvenido para ayudarme a pagar el servidor!'),
            //       h('div', { className: 'alias-container' },
            //         h('span', { className: 'alias-label' }, 'Alias: '),
            //         h('span', { className: 'alias-value' }, 'GFRISON')
            //       ),
            //       h('a', {
            //         href: 'https://link.mercadopago.com.ar/quiensevaapp',
            //         target: '_blank',
            //         rel: 'noopener noreferrer',
            //         className: 'text-blue-600 hover:text-blue-800 underline text-sm font-medium inline'
            //       }, 'Link Mercado Pago')
            //     )
            //   )
            // ),
            calcularTabla.hayEmpateTabla && h('div', { className: 'regla-descenso bg-orange-50 border-l-4 border-orange-500 p-2 md:p-3 text-sm mb-2 md:mb-3' },
              h('strong', null, '‚ö†Ô∏è Partido Definitorio (Tabla): '),
              `${calcularTabla.equiposEmpatadosTabla.length} equipos empatados en puntos en zona de descenso: ${calcularTabla.equiposEmpatadosTabla.map(id => equiposIniciales.find(e => e.id === id)?.nombre).join(', ')}. Se define por partido definitorio entre ellos.`
            ),
            calcularTabla.hayEmpatePromedios && h('div', { className: 'regla-descenso bg-orange-50 border-l-4 border-orange-500 p-2 md:p-3 text-sm' },
              h('strong', null, '‚ö†Ô∏è Partido Definitorio (Promedios): '),
              `${calcularTabla.equiposEmpatadosPromedios.length} equipos empatados en promedio en √∫ltima posici√≥n: ${calcularTabla.equiposEmpatadosPromedios.map(id => equiposIniciales.find(e => e.id === id)?.nombre).join(', ')}. Se define por partido definitorio entre ellos.`
            )
          ),
          h('div', { className: 'grid grid-cols-1 gap-4', id: 'captura-container' },
            h('div', { className: `grid ${esMobile && !mostrarPromedios ? 'grid-cols-1' : 'grid-cols-2 md:grid-cols-2'} gap-1 md:gap-4 ${esMobile && mostrarPromedios ? 'hide-pos-mobile' : ''}` },
              h('div', { className: 'bg-white rounded-lg shadow-xl p-2 md:p-4' },
                h('h2', { className: 'titulo-tabla text-xl font-bold mb-2 md:mb-3 text-gray-800' }, 'Tabla Anual'),
                h('div', { className: 'space-y-1 md:space-y-1.5' },
                  calcularTabla.equipos.map((equipo, idx) => {
                    const descendido = esDescendido(equipo.id);
                    const tipo = tipoDescenso(equipo.id);
                    const empate = esEmpateDescenso(equipo.id);

                    return h('div', {
                      key: equipo.id,
                      className: `p-1.5 md:p-2.5 rounded flex items-center justify-between min-h-[70px] md:min-h-[80px] ${empate ? 'bg-orange-100 border-2 border-orange-400' : descendido ? 'bg-red-100 border-2 border-red-400' : 'bg-green-50'}`
                    },
                      h('div', { className: 'flex items-center gap-1 md:gap-2' },
                        h('span', { className: 'tabla-posicion font-bold text-lg text-gray-700 w-5 md:w-6' }, idx + 1),
                        h('img', {
                          src: equipo.escudo,
                          alt: equipo.nombre,
                          className: 'w-8 h-8 md:w-10 md:h-10 object-contain mr-1'
                        }),
                        h('div', null,
                          h('div', { className: 'flex items-center gap-1 md:gap-2' },
                            h('span', { className: 'tabla-nombre font-bold text-base' }, equipo.nombre),
                            empate && h('span', { className: 'font-semibold text-orange-600 text-[10px] md:text-xs flex items-center gap-0.5' },
                              '‚ö†Ô∏è', h('span', null, 'Def')
                            )
                          ),
                          h('div', { className: 'tabla-info text-xs text-gray-600' },
                            h('div', null, `PJ: ${equipo.pjTemporada}`),
                            (equipo.puntosNecesarios === 0 && !descendido && !empate) && h('div', { className: 'text-green-600 font-semibold' },
                              'Salvado'
                            ),
                            equipo.puntosNecesarios > 0 && h('div', { className: 'flex items-center gap-1' },
                              h('span', { className: 'text-blue-600 font-semibold' }, `Necesita: ${equipo.puntosNecesarios} pts`),
                              equipo.id === 'ALD' && modoCalculo === 'seguro' && h('span', { className: 'text-orange-600 font-semibold text-[9px]' },
                                '(Dep. otros)'
                              )
                            )
                          )
                        )
                      ),
                      h('div', { className: 'text-right' },
                        h('div', { className: 'flex items-center gap-1 md:gap-3 justify-end' },
                          h('div', { className: `tabla-puntos ${esMobile && !mostrarPromedios ? 'text-2xl' : 'text-2xl'} font-bold text-green-700` }, equipo.puntosTemporada),
                          (esMobile && !mostrarPromedios) && h('span', { className: 'text-xl font-bold text-gray-400' }, '|'),
                          (esMobile && !mostrarPromedios) && h('div', { className: 'tabla-promedio text-xl font-bold text-blue-700' },
                            equipo.promedio.toFixed(3)
                          )
                        ),
                        descendido && !empate && h('div', { className: 'tabla-info text-xs font-semibold text-red-600 flex items-center gap-0.5 justify-end' },
                          h(TrendingDown, { size: 10, className: 'md:w-3 md:h-3' }),
                          tipo === 'Ambos' ? 'Prom+Tabla' : tipo === 'Promedios' ? 'Prom' : 'Tabla'
                        )
                      )
                    );
                  })
                )
              ),
              (esMobile && !mostrarPromedios) ? null : h('div', { className: 'bg-white rounded-lg shadow-xl p-2 md:p-4' },
                h('h2', { className: 'titulo-tabla text-xl font-bold mb-2 md:mb-3 text-gray-800 truncate' }, 'Tabla de Promedios'),
                h('div', { className: 'space-y-1 md:space-y-1.5' },
                  calcularTabla.tablaPromedios.map((equipo, idx) => {
                    const empatePromedios = esEmpatePromedios(equipo.id);
                    const esUltimo = idx === calcularTabla.tablaPromedios.length - 1;

                    return h('div', {
                      key: equipo.id,
                      className: `p-1.5 md:p-2.5 rounded min-h-[70px] md:min-h-[80px] ${empatePromedios ? 'bg-orange-100 border-2 border-orange-400' : esUltimo ? 'bg-red-100 border-2 border-red-400' : 'bg-blue-50'}`
                    },
                      h('div', { className: 'flex items-center justify-between' },
                        h('div', { className: 'flex items-center gap-1 md:gap-2' },
                          h('span', { className: 'tabla-posicion font-bold text-lg text-gray-700 w-5 md:w-6' }, idx + 1),
                          h('img', {
                            src: equipo.escudo,
                            alt: equipo.nombre,
                            className: 'w-8 h-8 md:w-10 md:h-10 object-contain'
                          }),
                          h('div', null,
                            h('div', { className: 'flex items-center gap-1 md:gap-2' },
                              h('span', { className: 'tabla-nombre font-bold text-base' }, equipo.nombre),
                              empatePromedios && h('span', { className: 'font-semibold text-orange-600 text-[10px] md:text-xs flex items-center gap-0.5' },
                                '‚ö†Ô∏è', h('span', null, 'Def')
                              )
                            ),
                            h('div', { className: 'tabla-info text-xs text-gray-600' },
                              `${equipo.pjPromediosTotales} PJ`
                            ),
                            h('div', { className: 'tabla-info text-xs text-gray-600' },
                              `${equipo.puntosPromediosTotales} pts`
                            )
                          )
                        ),
                        h('div', { className: 'text-right' },
                          h('div', { className: 'tabla-promedio text-2xl font-bold text-blue-700' },
                            equipo.promedio.toFixed(3)
                          ),
                          esUltimo && !empatePromedios && h('div', { className: 'tabla-info text-xs font-semibold text-red-600 flex items-center gap-0.5 justify-end' },
                            h(TrendingDown, { size: 10, className: 'md:w-3 md:h-3' }),
                            'Desc'
                          )
                        )
                      )
                    );
                  })
                )
              )
            ),
            h('div', { className: 'bg-white rounded-lg shadow-xl p-2 md:p-4' },
              h('h2', { className: 'titulo-tabla text-xl font-bold mb-2 md:mb-3 text-gray-800' }, 'Simulaci√≥n de Resultados'),
              h('div', { className: 'grid grid-cols-2 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2 md:gap-3' },
                equiposIniciales.map(equipo =>
                  h('div', { key: equipo.id, className: 'border-2 border-gray-200 rounded-lg p-2 md:p-3' },
                    h('div', { className: 'flex items-center gap-2 mb-1.5 md:mb-2' },
                      h('img', {
                        src: equipo.escudo,
                        alt: equipo.nombre,
                        className: 'w-6 h-6 md:w-7 md:h-7 object-contain'
                      }),
                      h('h3', { className: 'equipo-titulo font-bold text-base text-gray-800' }, equipo.nombre)
                    ),
                    h('div', { className: 'space-y-1 md:space-y-1.5' },
                      equipo.partidos.map((partido, idx) => {
                        const esLocal = partido.condicion === 'L';
                        const resultadoPartido = resultados[partido.partidoId];
                        const equipoGano = resultadoPartido === equipo.id;
                        const esEmpate = resultadoPartido === 'E';
                        const equipoPerdio = resultadoPartido && resultadoPartido !== equipo.id && resultadoPartido !== 'E';
                        const esJugado = partido.jugado === true;

                        return h('div', { key: idx, className: 'p-1 md:p-1.5 rounded' },
                          h('div', { className: 'partido-info text-xs mb-0.5 md:mb-1 flex items-center gap-1 md:gap-1.5' },
                            h('span', { className: 'font-semibold text-gray-700' }, `F${partido.fecha}`),
                            h('span', {
                              className: `px-1 md:px-1.5 py-0.5 rounded text-xs ${esLocal ? 'bg-blue-100 text-blue-800' : 'bg-orange-100 text-orange-800'}`
                            }, esLocal ? 'L' : 'V'),
                            h('span', { className: 'text-gray-600 text-xs truncate' }, partido.rival),
                            partido.pendiente && h('span', { className: 'text-xs bg-yellow-100 text-yellow-800 px-1 md:px-1.5 py-0.5 rounded' }, 'Pend')
                          ),
                          h('div', { className: 'flex gap-1' },
                            h('button', {
                              onClick: esJugado ? null : () => handleResultado(partido.partidoId, equipo.id, esLocal),
                              disabled: esJugado,
                              className: `flex-1 py-1 px-1 rounded text-xs font-semibold ${equipoGano ? 'bg-green-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-green-100'} ${esJugado ? 'opacity-100 cursor-not-allowed' : ''}`
                            }, 'G'),
                            h('button', {
                              onClick: esJugado ? null : () => handleResultado(partido.partidoId, equipo.id, esLocal, true),
                              disabled: esJugado,
                              className: `flex-1 py-1 px-1 rounded text-xs font-semibold ${esEmpate ? 'bg-yellow-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-yellow-100'} ${esJugado ? 'opacity-100 cursor-not-allowed' : ''}`
                            }, 'E'),
                            h('button', {
                              onClick: esJugado ? null : () => handleResultado(partido.partidoId, partido.rivalId || 'EXT', esLocal),
                              disabled: esJugado,
                              className: `flex-1 py-1 px-1 rounded text-xs font-semibold ${equipoPerdio ? 'bg-red-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-red-100'} ${esJugado ? 'opacity-100 cursor-not-allowed' : ''}`
                            }, 'P')
                          )
                        );
                      })
                    )
                  )
                )
              )
            )
          )
        )
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(h(App));
  </script>
</body>
</html>